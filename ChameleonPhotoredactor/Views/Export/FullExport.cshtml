@using System.Globalization
@{
    ViewData["Title"] = "Export Page";
    Layout = "~/Views/Shared/_LayoutFullExport.cshtml";
}

<div class="content-container_Full">

    <div class="image_container">
        @if (ViewBag.ImageData != null)
        {
            var base64 = Convert.ToBase64String(ViewBag.ImageData);
            var imgSrc = String.Format("data:{0};base64,{1}", ViewBag.ImageType, base64);

            var exposureValue = 1 + ((double)(ViewBag.Exposure ?? 0) / 100.0);
            var contrastValue = 1 + ((double)(ViewBag.Contrast ?? 0) / 100.0);
            var saturationValue = 1 + ((double)(ViewBag.Saturation ?? 0) / 100.0);

            var brightnessCss = exposureValue.ToString(CultureInfo.InvariantCulture);
            var contrastCss = contrastValue.ToString(CultureInfo.InvariantCulture);
            var saturationCss = saturationValue.ToString(CultureInfo.InvariantCulture);

            var filterStyle = $"brightness({brightnessCss}) contrast({contrastCss}) saturate({saturationCss})";

            <img src="@imgSrc" alt="Final Image" id="final_image" style="max-width: 500px; border-radius: 10px; filter: @filterStyle;" />
        }
        else
        {
            <p>No image selected. Please upload one.</p>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const img = document.getElementById("final_image");
            const downloadBtn = document.getElementById("export-download-trigger");
            const savedCropData = @Html.Raw(string.IsNullOrEmpty(ViewBag.CropData as string) ? "null" : ViewBag.CropData);

            if (img && savedCropData) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = savedCropData.width;
                canvas.height = savedCropData.height;

                ctx.drawImage(img, savedCropData.x, savedCropData.y, savedCropData.width, savedCropData.height, 0, 0, savedCropData.width, savedCropData.height);

                img.onload = null; 
                img.src = canvas.toDataURL();
            }

            if (img && typeof drawHistogram === "function") {
                const waitForCrop = () => {
                    if (img.complete) {
                        drawHistogram(img, img.style.filter);
                    } else {
                        img.onload = () => drawHistogram(img, img.style.filter);
                    }
                };
                waitForCrop();
            }

            if (downloadBtn && img) {
                downloadBtn.addEventListener("click", function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;

                    ctx.filter = img.style.filter;

                    ctx.drawImage(img, 0, 0);

                    const originalName = "@(ViewBag.FileName ?? "image.png")";
                    const newName = "edited-" + originalName;
                    const imageType = "@(ViewBag.ImageType ?? "image/png")";

                    const link = document.createElement('a');
                    link.download = newName;
                    link.href = canvas.toDataURL(imageType);

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
        });
    </script>
}
}